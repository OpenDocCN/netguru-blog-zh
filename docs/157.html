<html>
<head>
<title>Convert Flutter Mobile Application to Web With BLoC</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用BLoC将Flutter移动应用程序转换为Web</h1>
<blockquote>原文：<a href="http://web.archive.org/web/20230307163032/https://www.netguru.com/blog/mobile-and-web-shared-code-with-flutter#0001-01-01">http://web.archive.org/web/20230307163032/https://www.netguru.com/blog/mobile-and-web-shared-code-with-flutter#0001-01-01</a></blockquote><div><span><div class="blog-post__lead h3"><p>Flutter BLoC是一个很棒的建筑模式，受到了社区的热烈欢迎。但它不仅仅是为移动应用程序而创建的。它是作为一种模式引入的，允许在Flutter和AngularDart应用程序之间共享多达50%的代码。在这篇博文中，我将分享<a href="/web/20221209114049/https://www.netguru.com/services/flutter-app-development" rel="noopener">将我的Flutter转换到web应用程序的经验，并将这个解决方案与Flutter For Web </a>进行比较。</p></div><p>与手机和网络共享代码</p>
<h2>在这篇博文中，我将使用我在BLoC教程中创建的应用程序。如果你不熟悉BLoC模式，或者如果你想更好地了解我将要转换的应用程序，我建议你先看一看。完成的共享代码应用程序可以在这个<a href="http://web.archive.org/web/20221209114049/https://github.com/kkogut95/bloc_lyrics_shared">存储库</a>中找到。</h2>
<p>只有当你想在手机和网络上有相同的行为时，共享的应用程序代码才能被应用。当然，您可以为一个平台创建不同状态、事件和阻塞，但是创建太多的状态、事件和阻塞会降低共享代码的利润。您的应用程序也必须基于BLoC模式构建。如果它是基于<a href="http://web.archive.org/web/20221209114049/https://bloclibrary.dev/#/"> BLoC库</a>创建的就更好了，该库在Flutter和AngularDart上都受支持。</p>
<p>由于移动和web应用程序将以相同的方式运行，并具有相同的状态和事件，因此它们可以共享除UI类之外的所有内容。请记住，标准共享块应用程序的图表可能如下所示:</p>
<p> </p>
<p> </p>
<p/><figure class="image&#10;    &#10;    image--framed&#10;    " data-image="" data-component="image">
    <img class="image__content" srcset="http://web.archive.org/web/20221209114049im_/https://www.netguru.com/hs-fs/hubfs/Untitled%20Diagram%20(3).png?width=521&amp;name=Untitled%20Diagram%20(3).png 521w, http://web.archive.org/web/20221209114049im_/https://www.netguru.com/hs-fs/hubfs/Untitled%20Diagram%20(3).png?width=1042&amp;name=Untitled%20Diagram%20(3).png 1042w" src="../Images/78318e32f5a1dbc218f91c3308f952c8.png" alt="Untitled Diagram (3)" loading="lazy" data-image-content="" data-original-src="http://web.archive.org/web/20221209114049im_/https://www.netguru.com/hs-fs/hubfs/Untitled%20Diagram%20(3).png?width=521&amp;name=Untitled%20Diagram%20(3).png"/>
  </figure><p>正如您在上面的图表中看到的，提供数据和应用程序状态的所有三个层都在移动和web UI之间共享。</p>
<p>将Flutter应用程序转换为共享代码</p>
<h2>开始使用共享代码时，我必须做的第一件事是将所有的共享类移动到一个新的文件夹中，这个文件夹应该创建在移动和web应用程序所在的位置。所以最后，包含应用程序的文件夹应该是这样的:</h2>
<p>The first thing I had to do to start working with shared code is to move all of the shared classes to a new folder, which should be created in the same place that mobile and web applications will be. So in the end, a folder containing the application should look like this:</p>
<p/><figure class="image&#10;    &#10;    image--framed&#10;    " data-image="" data-component="image">
    <img class="image__content" srcset="http://web.archive.org/web/20221209114049im_/https://www.netguru.com/hubfs/Screenshot%202019-11-29%20at%2015.18.56.png 0w" src="../Images/c830230d688c38cb5e22bb9e329530f9.png" alt="" loading="lazy" data-image-content="" data-original-src="http://web.archive.org/web/20221209114049im_/https://www.netguru.com/hubfs/Screenshot%202019-11-29%20at%2015.18.56.png"/>
  </figure><p>可以在web和mobile之间共享的类可以是提供数据和管理应用程序状态的所有类。因此，所有的块、模型、存储库和数据提供者都可以移动到<strong> common_bloc_lyrics </strong>。</p>
<p>之后，我必须添加一个pubspec.yaml文件，这样它就可以提供必要的依赖项，并允许将这个包导入到web和移动项目中。</p>
<p>然后，我必须创建一个文件<strong> common_bloc_lyrics.dart，</strong>，它将导出这个新包将提供的所有依赖项。</p>
<pre><code class="language-yaml">name: common_bloc_lyrics
description: Lyrics app shared Code between AngularDart and Flutter

version: 1.0.0+1

environment:
  sdk: "&gt;=2.1.0 &lt;3.0.0"

dependencies:
  meta: ^1.1.6
  equatable: ^0.2.0
  http: ^0.12.0
  bloc: ^2.0.0
</code></pre>
<p>现在，我必须将这个包中的所有导入更改为新创建的文件的导入。</p>
<pre><code class="language-dart">export 'src/model/song_base.dart';
export 'src/model/api/search_result_error.dart';
export 'src/model/api/search_result.dart';
export 'src/model/api/song_result.dart';
export 'src/model/api/artist.dart';

export 'src/repository/local_client.dart';
export 'src/repository/lyrics_repository.dart';
export 'src/repository/lyrics_client.dart';

export 'src/bloc/song/search/songs_search.dart';
export 'src/bloc/song/add_edit/song_add_edit.dart';
</code></pre>
<p>就这样。由于这些变化，共享库可以被Flutter和AngularDart项目导入。</p>
<pre><code class="language-yaml">import 'package:common_bloc_lyrics/common_bloc_lyrics.dart';
</code></pre>
<p>对Flutter应用程序的更改</p>
<h2>由于所有的共享依赖项都是从移动应用程序项目中移走的，所以我必须修改我的Flutter项目的pubspec.yaml文件，以便它可以导入这些类，就像它只是另一个插件一样。</h2>
<p>在那之后，我只需要将所有共享的类的导入更改为在公共包中创建的导出文件，类似于我之前所做的。每个使用BLoC或models的类都应该有这样的导入:</p>
<pre><code class="language-yaml">name: flutter_mobile_bloc_lyrics
description: Flutter BLoC shared code example

version: 1.0.0+1

environment:
  sdk: "&gt;=2.1.0 &lt;3.0.0"

dependencies:
  ...
  common_bloc_lyrics:
    path: ../common_bloc_lyrics
</code></pre>
<p>就这样。由于这些改变，我已经设法使我的移动应用程序与共享代码包一起工作。</p>
<pre><code class="language-dart">import 'package:common_bloc_lyrics/common_bloc_lyrics.dart';
</code></pre>
<p>角省道应用</p>
<h2>为了创建AngularDart项目，我使用了推荐的<a href="http://web.archive.org/web/20221209114049/https://github.com/dart-lang/stagehand"> Dart项目生成器</a>，称为Stagehand。下载之后，我还必须<a href="http://web.archive.org/web/20221209114049/https://stackoverflow.com/a/43765187/7120147">更新我的系统路径</a>，这样它就会指向需要的工具。</h2>
<p>使用Stagehand创建AngularDart应用程序与生成新的Flutter项目一样简单，您只需键入以下命令:</p>
<p>正如我之前所说的，我没有很多使用web应用程序的经验。我写的这个是基于BLoC库文档中的<a href="http://web.archive.org/web/20221209114049/https://bloclibrary.dev/#/flutterangulargithubsearch"> Github搜索示例</a>。</p>
<pre><code class="language-txt">stagehand web-angular</code></pre>
<p>由于这段代码与示例中的代码非常相似，所以我不会描述web项目本身。但是如果你对它是什么样子很好奇，你可以去看看它的<a href="http://web.archive.org/web/20221209114049/https://github.com/kkogut95/bloc_lyrics_shared">资源库</a>。</p>
<p>要在浏览器中运行AngularDart项目，您需要执行以下命令:</p>
<p>To run AngularDart projects in your browser you need to execute  this command:</p>
<pre><code class="language-txt">webdev serve</code></pre>
<p/><figure class="image&#10;    &#10;    image--framed&#10;    " data-image="" data-component="image">
    <img class="image__content" srcset="http://web.archive.org/web/20221209114049im_/https://www.netguru.com/hs-fs/hubfs/screencast%202019-11-28%2016-57-31.gif?width=481&amp;name=screencast%202019-11-28%2016-57-31.gif 481w, http://web.archive.org/web/20221209114049im_/https://www.netguru.com/hs-fs/hubfs/screencast%202019-11-28%2016-57-31.gif?width=962&amp;name=screencast%202019-11-28%2016-57-31.gif 962w" src="../Images/951dc1d57f40ab99324915cecb00c4ad.png" alt="screencast 2019-11-28 16-57-31" loading="lazy" data-image-content="" data-original-src="http://web.archive.org/web/20221209114049im_/https://www.netguru.com/hs-fs/hubfs/screencast%202019-11-28%2016-57-31.gif?width=481&amp;name=screencast%202019-11-28%2016-57-31.gif"/>
  </figure><p>使用AngularDart与<a href="/web/20221209114049/https://www.netguru.com/blog/is-flutter-a-programming-language" rel="noopener">用Flutter </a>编写应用程序有很大不同。视图是用HTML编写的，Dart文件为它们提供数据和类实例。</p>
<p>例如，项目的搜索栏Dart类如下所示:</p>
<p>它看起来类似于该组件的移动应用程序版本。由于有了<strong> @Input() </strong>注释，SongSearchBloC被注入到这个类中。与移动版本类似，每次搜索栏中的输入发生变化时，都应该调用方法<strong> onTextChanged </strong>。<strong> templateUrl </strong>属性告诉我们应该使用哪个视图布局来创建这个组件。搜索栏HTML文件如下所示:</p>
<pre><code class="language-dart">import 'package:angular/angular.dart';

import 'package:common_bloc_lyrics/common_bloc_lyrics.dart';

@Component(
  selector: 'search-bar',
  templateUrl: 'song_search_bar_component.html',
)
class SearchBarComponent {
  @Input()
  SongsSearchBloc songsSearchBloc;

  void onTextChanged(String text) {
    songsSearchBloc.add(TextChanged(query: text));
  }
}
</code></pre>
<p>由于有了<strong> keyup </strong>关键字，在用户输入的每个字符上，都会调用Dart类中的函数onTextChanges。</p>
<pre><code class="language-html">&lt;label class="clip" for="term"&gt;Enter song title&lt;/label&gt;
&lt;input
  id="term"
  placeholder="Song title"
  class="input-reset outline-transparent glow o-50 bg-near-black near-white w-100 pv2 border-box b--white-50 br-0 bl-0 bt-0 bb-ridge mb3"
  autofocus
  (keyup)="onTextChanged($event.target.value)"
/&gt;
</code></pre>
<p>BLoC注入的依赖项是在主搜索组件中创建的，与移动版本类似，它为搜索栏和列表创建视图实例。</p>
<p>在<strong> ngOnInit </strong>中初始化BLoC确保它的实例将在组件初始化时被创建，并且可以被这个类中创建的所有视图访问。每次视图被销毁，方法<strong> ngOnDestroy </strong>被调用。因此，这是关闭BLoC的最佳位置，因为它将不再被需要。</p>
<pre><code class="language-dart">@Component(
    selector: 'search-form',
    templateUrl: 'search_song_component.html',
    directives: [
      SearchBarComponent,
      SearchBodyComponent
    ],
    pipes: [
      BlocPipe
    ])
class SearchSongComponent implements OnInit, OnDestroy {
  @Input()
  LyricsRepository lyricsRepository;

  SongsSearchBloc songsSearchBloc;

  @override
  void ngOnInit() {
    songsSearchBloc = SongsSearchBloc(
      lyricsRepository: lyricsRepository,
    );
  }

  @override
  void ngOnDestroy() {
    songsSearchBloc.close();
  }
}
</code></pre>
<p>由于web应用程序有特殊的安全限制，值得指出的是，如果web服务器没有设置从应用程序所在的域接受请求的<strong> CORS </strong>头，那么您就不能向它发出请求。我用过的API没有这个功能，所以要运行我的web应用程序，我必须在没有CORS的情况下运行浏览器。当你在使用一个定制的API时，给它添加CORS头文件并不困难，但是你需要记住，你不能用大多数外部API做到这一点。</p>
<p>将应用程序转换为Flutter web</p>
<h2>创建一个共享的web和移动应用程序需要时间。它还需要一些关于省道、扑动和成角的知识。对于大多数移动开发者来说，这可能不是最好的解决方案。但是，如果你想把你的Flutter应用程序转换成web格式，有一个更简单的方法。</h2>
<p>Flutter For Web让您可以轻松地将任何应用程序转换为可工作的Web应用程序，无论您使用哪种架构。由于它仍处于预览阶段，因此不建议在生产就绪的应用程序中使用。</p>
<p>如果你想了解更多，我推荐这篇文章。通过遵循本文中描述的步骤，我成功地在浏览器上本地转换和运行了我的应用程序。</p>
<p>为了让我的应用程序工作，我必须在Java代码中做一些变通。您可以看到我是如何在库中的<a href="http://web.archive.org/web/20221209114049/https://github.com/kkogut95/flutter_web_bloc_lyrics/commits/master">提交中做到这一点的。</a></p>
<p>但是这些解决办法仍然没有让我的应用程序工作，我看到的只是一个白屏。我要做的下一件事是删除我用于应用程序翻译的库，因为它在web上不受支持。</p>
<p>But these workarounds still didn't make my app work and all I saw was a white screen. The next thing that I had to do was to remove the library that I used for app translations, since it was not supported on the web. </p>
<p/><figure class="image&#10;    &#10;    image--framed&#10;    " data-image="" data-component="image">
    <img class="image__content" srcset="http://web.archive.org/web/20221209114049im_/https://www.netguru.com/hs-fs/hubfs/screencast%202019-11-29%2013-42-06.gif?width=495&amp;name=screencast%202019-11-29%2013-42-06.gif 495w, http://web.archive.org/web/20221209114049im_/https://www.netguru.com/hs-fs/hubfs/screencast%202019-11-29%2013-42-06.gif?width=990&amp;name=screencast%202019-11-29%2013-42-06.gif 990w" src="../Images/32a38e0eb9ef8bd4f7eb8197770f707d.png" alt="screencast 2019-11-29 13-42-06" loading="lazy" data-image-content="" data-original-src="http://web.archive.org/web/20221209114049im_/https://www.netguru.com/hs-fs/hubfs/screencast%202019-11-29%2013-42-06.gif?width=495&amp;name=screencast%202019-11-29%2013-42-06.gif"/>
  </figure><p>这些修复使我的应用程序能够工作，但并不是所有的东西都像它应该的那样运行。在移动应用版本中，当你滑动列表中的元素时，它会被移除。但是类似于用于翻译的库，用于滑动和删除的库在web项目上不受支持。</p>
<p>令我惊喜的是，集团图书馆发挥了应有的作用。web应用程序中没有任何不同。</p>
<p>摘要</p>
<h2>目前，移动开发者还没有简单的方法将他们的移动应用程序转换成生产就绪的网络应用程序。使用共享代码需要大量的知识，但它并没有得到很好的支持，因为AngularDart不像其他web技术那样流行。但是现在，最好的方法是用Flutter创建一个生产就绪的web应用程序。这是为Flutter web的成功祈祷的另一个原因。</h2>
<p> </p>
<p><span>照片由</span> <a href="http://web.archive.org/web/20221209114049/https://unsplash.com/@yogasdesign?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">青奥会设计</a> <span>于</span> <a href="http://web.archive.org/web/20221209114049/https://unsplash.com/s/photos/smartphone-laptop?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText"> Unsplash </a></p>
<p><span>Photo by </span><a href="http://web.archive.org/web/20221209114049/https://unsplash.com/@yogasdesign?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Yogas Design</a><span> on </span><a href="http://web.archive.org/web/20221209114049/https://unsplash.com/s/photos/smartphone-laptop?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></p></span></div>    
</body>
</html>