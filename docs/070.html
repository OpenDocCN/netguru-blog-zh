<html>
<head>
<title>Hello Instant Apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>你好即时应用</h1>
<blockquote>原文：<a href="http://web.archive.org/web/20230307163032/https://www.netguru.com/blog/hello-instant-apps#0001-01-01">http://web.archive.org/web/20230307163032/https://www.netguru.com/blog/hello-instant-apps#0001-01-01</a></blockquote><div><div id="hs_cos_wrapper_post_body"><span><div class="blog-post__lead h3"><p><a href="/web/20220927121741/https://www.netguru.com/blog/android-instant-apps" rel="noopener">即时应用是向用户介绍本地应用体验的绝佳方式，无需安装</a>。由于其大小限制(4MB)，称为功能的应用程序片段可以快速下载。这为那些负担不起安装整个应用程序或不想为一个功能下载整个应用程序的人带来了出色的用户体验。只需将应用程序链接分配到您的功能模块。现在，每当用户点击即时应用程序模式中的链接，并且您的应用程序通过验证，而不是打开浏览器，Play Store将下载您的功能，缓存它并启动您的本地应用程序的一部分。</p></div><h2><span>要求和限制</span></h2>
<p>即时应用带来了一些新的功能、要求和限制。</p>
<p> </p>
<h5><strong>即时应用需求:</strong></h5>
<p><span>在开始开发你的第一个即时应用程序之前，你需要满足几个要求:</span></p>

<h5> </h5>
<h5><strong>即时应用程序限制:</strong></h5>
<p>正如我之前提到的，即时应用有一些限制。您需要记住，与API的通信必须通过https来完成。你的应用将无法使用后台服务、发送后台通知或访问唯一的设备标识符。</p>
<p><span>即时应用的权限列表也减少了，这里是全部:</span></p>

<h2><span>创建你的第一个即时应用</span></h2>
<p>从头开始构建即时应用非常简单。但是在你开始之前，我建议你花一些时间考虑一下你的项目应该是什么样子，它会有什么特性，它会共享什么代码库/资源/依赖。以后会派上用场的。现在让我们开始创建我们的第一个即时应用程序。</p>
<h2><figure class="image&#10;    &#10;    image--framed&#10;    " data-component="image"><img class="image__content" srcset="http://web.archive.org/web/20220927121741im_/https://www.netguru.com/hs-fs/hubfs/Screen%20Shot%202018-08-28%20at%2010.58.07.png?width=600&amp;name=Screen%20Shot%202018-08-28%20at%2010.58.07.png 600w, http://web.archive.org/web/20220927121741im_/https://www.netguru.com/hs-fs/hubfs/Screen%20Shot%202018-08-28%20at%2010.58.07.png?width=1200&amp;name=Screen%20Shot%202018-08-28%20at%2010.58.07.png 1200w" src="../Images/6243fe1bb89cb505cb81fc1306d75bfc.png" alt="select_the_form_factors_and_minimum_sdk" loading="lazy" data-original-src="http://web.archive.org/web/20220927121741im_/https://www.netguru.com/hs-fs/hubfs/Screen%20Shot%202018-08-28%20at%2010.58.07.png?width=600&amp;name=Screen%20Shot%202018-08-28%20at%2010.58.07.png"/>T2】</figure></h2>
<p><span>创建新项目时，记得选择API 21或更高版本，同时确保选中“<em>包括Android即时应用支持</em>”复选框。</span></p>
<p> </p>
<figure class="image&#10;    &#10;    image--framed&#10;    " data-component="image">
    <img class="image__content" srcset="http://web.archive.org/web/20220927121741im_/https://www.netguru.com/hs-fs/hubfs/Screen%20Shot%202018-08-28%20at%2011.08.57.png?width=600&amp;name=Screen%20Shot%202018-08-28%20at%2011.08.57.png 600w, http://web.archive.org/web/20220927121741im_/https://www.netguru.com/hs-fs/hubfs/Screen%20Shot%202018-08-28%20at%2011.08.57.png?width=1200&amp;name=Screen%20Shot%202018-08-28%20at%2011.08.57.png 1200w" src="../Images/c5b9fa1356b99d96de9dbe97b3c47523.png" alt="configure_feature" loading="lazy" data-original-src="http://web.archive.org/web/20220927121741im_/https://www.netguru.com/hs-fs/hubfs/Screen%20Shot%202018-08-28%20at%2011.08.57.png?width=600&amp;name=Screen%20Shot%202018-08-28%20at%2011.08.57.png"/>
  </figure>
<p><span>您现在可以指定您的第一个功能模块名称。Android Studio将创建模块</span></p>
<ul>
<li>
<p><span><em>app</em>——负责生成可安装的apk </span></p>
</li>
<li>
<p><span><em>基础</em>——所有特性之间共享的模块</span></p>
</li>
<li>
<p><span><em>instant app</em>——生成包含所有功能模块的即时app zip包<em> apks </em> </span></p>
</li>
</ul>
<p><span><em/>T2】</span></p>
<p><span>向功能模块添加新活动时，系统会要求您指定应用程序链接。意图过滤器将仅使用https方案创建，因此我建议您转到清单文件并包含http。</span></p><figure class="image&#10;    &#10;    image--framed&#10;    " data-component="image"><em>
    <img class="image__content" srcset="http://web.archive.org/web/20220927121741im_/https://www.netguru.com/hs-fs/hubfs/Screen%20Shot%202018-08-28%20at%2011.04.36.png?width=600&amp;name=Screen%20Shot%202018-08-28%20at%2011.04.36.png 600w, http://web.archive.org/web/20220927121741im_/https://www.netguru.com/hs-fs/hubfs/Screen%20Shot%202018-08-28%20at%2011.04.36.png?width=1200&amp;name=Screen%20Shot%202018-08-28%20at%2011.04.36.png 1200w" src="../Images/bb5fae0d3658a761feabf49fbeeb00f5.png" alt="new_empty_activity" loading="lazy" data-original-src="http://web.archive.org/web/20220927121741im_/https://www.netguru.com/hs-fs/hubfs/Screen%20Shot%202018-08-28%20at%2011.04.36.png?width=600&amp;name=Screen%20Shot%202018-08-28%20at%2011.04.36.png"/>
  </em></figure></span><p>在最后一步之后，您应该已经生成了四个模块。现在让我们更仔细地看一看它们。</p>
<p><span> </span></p>
<p><strong>app(gradle plugin:apply plugin:' com . Android . application ')</strong></p>
<p>其主要目的是将所有模块合并成可安装的apk。如果你的可安装应用程序与即时应用程序没有区别，这个模块将保持原样。只要记住添加每一个新功能作为依赖。</p>
<h5> </h5>
<pre><code class="language-kotlin">apply plugin: 'com.android.application'

android {
   ...
   
   defaultConfig {
       applicationId "com.example.android.myapplication.app"
       ...
   }

   ...

}

dependencies {
   implementation project(':feature')
   implementation project(':base')
}</code></pre>
<p><strong>instant app(gradle plugin:apply plugin:' com . Android . instant app ')</strong></p>
<p>只需在最终的instant app zip文件中添加您想要的所有功能的依赖关系。你也可以在这里添加建筑类型和风格。</p>
<h5><span> </span></h5>
<pre><code class="language-kotlin">apply plugin: 'com.android.instantapp'

dependencies {
   implementation project(':feature')
   implementation project(':base')
}</code></pre>
<p><strong>base(gradle plugin:apply plugin:' com . Android . feature ')</strong></p>
<p><span>这里我们有一些新的东西:</span> <em> <span> baseFeature true。</span> </em> <span>这个设置告诉<em> gradle </em>所有的rest特性都将从这个特性中获得它们共享的代码和资源。由于基本特性</span> <span>应用程序项目(':app') </span> <span>声明，我们不需要为instantapp模块指定应用程序id。一个基地将从我们的可安装模块中获取它所需要的一切。请记住，这里还包括所有功能模块。在向基本模块添加代码、依赖项和资源时，请记住，无论是基本模块还是功能模块，都不能超过为当今即时应用程序设置的4MB限制。</span></p>
<h5> </h5>
<pre><code class="language-kotlin">apply plugin: 'com.android.feature'

android {
   compileSdkVersion 28
   baseFeature true
   defaultConfig {
       minSdkVersion 21
       targetSdkVersion 28
       versionCode 1
       versionName "1.0"
   }
   ...
}

dependencies {
   api 'com.android.support:appcompat-v7:28.0.0-rc01'
   api 'com.android.support.constraint:constraint-layout:1.1.2'
   application project(':app')
   feature project(':feature')
}</code></pre>
<p><strong>功能(gradle插件:应用插件:' com.android.feature') </strong></p>
<p>正如你所看到的，一个功能模块不同于你的可安装模块，因为它没有实现所有的功能，而且我们不需要指定应用程序id，因为它有一个基本的功能依赖关系。</p>
<h5>这是你的第一个hello world即时应用程序。现在通过文件/新建/新建模块/特性模块添加一些新特性</h5>
<pre><code class="language-kotlin">apply plugin: 'com.android.feature'
apply plugin: 'kotlin-android'
apply plugin: 'kotlin-android-extensions'

android {
   ...
}

dependencies {
   implementation fileTree(dir: 'libs', include: ['*.jar'])
   implementation"org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version"
   implementation project(':base')
   ...
}</code></pre>
<p>请记住，从现在开始，你需要像这样开始你的活动:</p>

<p><strong>应用链接变得简单(工具/应用链接助手)</strong></p>
<p><span> App Links Assistant是管理你的App链接的有用工具。让我提一下它的一些特性</span></p>
<pre><code class="language-kotlin">val intent = Intent(Intent.ACTION_VIEW, Uri.parse("https://android.example.com/character")
startActivity(intent)</code></pre>
<h3><strong> URL映射</strong></h3>
<p><span>要访问此功能，您需要打开URL映射编辑器，并在Url映射表中按“+”。使用这个工具，您可以轻松地将您的活动映射到您想要的链接。如果你想使用这个工具，你必须记住把不同的</span> <em> <span> &lt;数据/ &gt; </span> </em> <span>放在不同的</span> <em> <span> &lt;意图过滤&gt; </span> </em> <span>块中，否则这个工具在区分每个URL映射时会有一些问题。重新格式化选项真的很差，所以我建议手动操作，或者干脆不要使用这个工具。</span></p>
<h5><span>编辑后，适当的过滤器将被添加到<em> AndroidManifest文件</em> </span></h5>
<h5><span>记住总是用http方案复制这个过滤器</span></h5>
<p> </p>
<p><strong>关联网站</strong></p>
<pre><span>&lt;intent-filter&gt;</span><span><br/></span><span>   &lt;action android:name="android.intent.action.VIEW" /&gt;</span><span><br/></span><span><br/></span><span>   &lt;category android:name="android.intent.category.DEFAULT" /&gt;</span><span><br/></span><span>   &lt;category android:name="android.intent.category.BROWSABLE" /&gt;</span><span><br/></span><span><br/></span><span>   &lt;data</span><span><br/></span><span>       android:scheme="https"</span><span><br/></span><span>       android:host="android.example.com"</span><span><br/></span><span>       android:pathPattern="/character" /&gt;</span><span><br/></span><span>&lt;/intent-filter&gt;</span></pre>
<p><span>为了能够将您的即时应用程序zip包上传到Play Store，您的应用程序链接需要经过验证。为此，您需要将数字资产链接json文件添加到您网站的已知位置<em> ({site_domain}/)。【T2知名/assetlinks.json】。有了这个工具，你所要做的就是指定你的应用程序id和网站域，如果你想使用智能锁API，你应该检查支持共享凭证...如果与域名相同，则添加登录URL或标记复选框。点击generate按钮，您就可以下载/复制并粘贴assetlinks.json文件了。</em></span> <span> <br/> </span> <span>更多信息:</span><span><a href="http://web.archive.org/web/20220927121741/https://developer.android.com/training/app-links/verify-site-associations">https://developer . Android . com/training/app-links/verify-site-associations</a></span></p>
<p><strong>运行</strong> <strong>你的即时App </strong></p>
<h5>有几种方法可以运行即时应用程序。</h5>
<p> </p>
<h3><strong>定制版本</strong></h3>
<p><strong/></p>
<p><span>如您所见，您需要将</span> <span>启动</span> <span>从</span> <span>默认活动</span> <span>更改为</span> <span> URL </span> <span>，并指定您想要的URL。别担心，Android Studio不会允许你用错误的URL创建配置，因为它会在接受之前扫描你的AndroidManifest文件。</span></p>
<h5> </h5>
<p><strong>当您的即时应用程序在设备上运行时，启动ADB的功能</strong></p><figure class="image&#10;    &#10;    image--framed&#10;    " data-component="image"><strong>
    <img class="image__content" srcset="http://web.archive.org/web/20220927121741im_/https://www.netguru.com/hs-fs/hubfs/Screen%20Shot%202018-08-29%20at%2016.19.22.png?width=600&amp;name=Screen%20Shot%202018-08-29%20at%2016.19.22.png 600w, http://web.archive.org/web/20220927121741im_/https://www.netguru.com/hs-fs/hubfs/Screen%20Shot%202018-08-29%20at%2016.19.22.png?width=1200&amp;name=Screen%20Shot%202018-08-29%20at%2016.19.22.png 1200w" src="../Images/045bc807fb0047bde06fa0f6182a9d1a.png" alt="custom_build" loading="lazy" data-original-src="http://web.archive.org/web/20220927121741im_/https://www.netguru.com/hs-fs/hubfs/Screen%20Shot%202018-08-29%20at%2016.19.22.png?width=600&amp;name=Screen%20Shot%202018-08-29%20at%2016.19.22.png"/>
  </strong></figure><p><span>如果你想让<span>启动<span> </span> </span>一个特定的特性，你可以使用这个ADB命令:</span></p>
<p><strong>测试应用链接</strong></p>
<p>转到应用链接助手，并选择最后一个选项测试应用链接。从这里你可以选择你的应用程序应该从哪个模块运行安装/即时应用程序，并添加所需的网址。如果Android Studio找不到与URL相关联的<inetnt-filter>，您将无法启动run。</inetnt-filter></p>
<h5> </h5>
<p><strong>立即尝试按钮</strong></p>
<pre><code class="language-kotlin">adb shell am start -a android.intent.action.VIEW -d “{url}”</code></pre>

<h5><span>在成功将应用程序链接添加到您的所有活动后，现在是时候决定哪一个将成为您的即时应用程序默认活动，哪一个将由<strong>立即尝试</strong> Play Store的按钮启动。为此，您需要将</span> <em> <span> &lt;元数据/ &gt; </span> </em> <span>块添加到活动</span>中</h5>
<p> </p>
<p><strong>关于空间要求的更多信息</strong></p>
<figure class="image&#10;    &#10;    image--framed&#10;    " data-component="image">
    <img class="image__content" srcset="http://web.archive.org/web/20220927121741im_/https://www.netguru.com/hs-fs/hubfs/Screen%20Shot%202018-08-29%20at%2016.34.39.png?width=600&amp;name=Screen%20Shot%202018-08-29%20at%2016.34.39.png 600w, http://web.archive.org/web/20220927121741im_/https://www.netguru.com/hs-fs/hubfs/Screen%20Shot%202018-08-29%20at%2016.34.39.png?width=1200&amp;name=Screen%20Shot%202018-08-29%20at%2016.34.39.png 1200w" src="../Images/e6ea2a871484e9d549e2e0fefd63401f.png" alt="test_on_device" loading="lazy" data-original-src="http://web.archive.org/web/20220927121741im_/https://www.netguru.com/hs-fs/hubfs/Screen%20Shot%202018-08-29%20at%2016.34.39.png?width=600&amp;name=Screen%20Shot%202018-08-29%20at%2016.34.39.png"/>
  </figure>
<h3><span>使用网页浏览图片</span></h3>
<p><span>删除未使用的代码</span></p>
<pre> <span>&lt;meta-data</span><span><br/></span><span>   android:name="default-url"</span><span><br/></span><span>   android:value="https://android.example.com/character" /&gt;<br/></span></pre>
<p>尝试为即时应用程序找到轻量级的库，并使用继承和合成将它们替换为已安装版本中所需的库</p>
<p><span>使用重构/移除未使用的资源...</span></p>
<span>We already know how important is the size of your features so I would like to share some great tips for reducing your apks sizes:</span><span><br/><br/></span>
<ul>
<li><span>使用gradle中的splits将资源拆分成不同的apk</span></li>
<li>正如我之前告诉你的，即时应用基本功能和任何其他功能加起来不能超过4 MB的大小限制。并不意味着你的整个app不能像你想的那么大。你所要记住的就是坚持4 MB规则。例如，如果您的基本功能大小为2 MB，则所有功能占用的空间必须小于2MB。将即时应用程序上传到Play Store时，将检查您的功能大小。</li>
<li>谷歌最近推出了针对即时应用的10 MB计划。如果你想参加，你所要做的就是填写这张<a href="http://web.archive.org/web/20220927121741/https://docs.google.com/forms/d/e/1FAIpQLScVKwTCzjeh6brMyCKpJqdcxZXW7WX9ho__TCj5YVEz-Kaovw/viewform">表格</a>。</li>
<li><strong>在即时应用中处理程序</strong></li>
<li>使用即时应用程序，你可能至少需要两个proguard规则文件。一个用于应用程序的可安装版本，另一个用于基本功能模块。首先，为你的可安装版本创建规则，并用apply插件将它添加到一个模块中:'<em> com.android.application </em>'。现在在特性中，proguard变得有点棘手，因为你的应用程序不会被构建到一个大的apk文件中。每个模块都将单独构建，然后打包成一个zip文件。所以你的基本特性不知道你的一个特性使用了它的一个util类，你需要告诉proguard把这些类分开。apkanalzyer的少量文字处理和使用将对此有用。使用任何具有的变体构建您的应用</li>
</ul>
<pre><code class="language-kotlin">android {
    ...
    splits {
        generatePureSplits true
        density {enable true }
    }
} </code></pre>

<p><span> <em> minifyEnabled </em>设为<em> false </em>。现在，对于位于构建文件夹中的所有特性apk，运行命令:</span></p>
<p> </p>
<h3>该命令行将生成一个类列表，您必须将这些类作为keep规则添加到您的功能模块的proguard文件中。</h3>
<p><span>更多信息</span><span><br/></span><a href="http://web.archive.org/web/20220927121741/https://medium.com/google-developers/enabling-proguard-in-an-android-instant-app-fbd4fc014518"><span>https://medium . com/Google-developers/enabling-proguard-in-an-Android-instant-app-FBD 4 fc 014518</span></a></p>
<p><strong>一些通用提示</strong></p>

<pre><span>$ comm -23 &lt;(~/Library/Android/sdk/tools/bin/apkanalyzer dex packages detail-debug.apk | grep "^C r" | cut -f4 | sort) &lt;(jar tf ~/Android/Sdk/platforms/android-xx/android.jar | sed s/.class$// | sed -e s-/-.-g | sort)</span></pre>
<p><span>即使您在创建项目时选择了kotlin支持，基本功能模块也不会自动添加koltin依赖项和插件</span></p>
<p><span>在即时应用和已安装应用之间切换测试之前，记得从设备上移除应用，否则会导致运行时崩溃</span></p>
<p><span>尽管权限严格，您仍然可以访问内部存储器</span></p>
<h3><span>即时应用程序可以访问</span><a href="http://web.archive.org/web/20220927121741/https://developer.android.com/reference/android/content/pm/PackageManager.html#getInstantAppCookie()"><span>Cookie API</span></a><span>所以使用它将一些用户数据从即时应用程序转移到已安装的应用程序是明智的。</span> <span> <br/> </span> <span>为了保证每个应用从你的URL启动一个即时app使用</span> <a href="http://web.archive.org/web/20220927121741/https://firebase.google.com/docs/dynamic-links/"> <span> Firebase动态链接</span></a><span>:</span><span><br/></span><span>Google推荐的用户授权方式，是使用</span> <a href="http://web.archive.org/web/20220927121741/https://developers.google.com/identity/smartlock-passwords/android/overview"> <span> AUTH服务</span><span><br/></span></a><span>配合</span> <a href="http://web.archive.org/web/20220927121741/https://developers.google.com/android/reference/com/google/android/gms/instantapps/package-summary"> <span>即时App API </span></a></h3>
<ul>
<li><a href="http://web.archive.org/web/20220927121741/https://developers.google.com/android/reference/com/google/android/gms/instantapps/PackageManagerCompat.html"><span>package manager compat</span></a><span>——允许您在API &lt; 26 </span>的设备上使用cookie API</li>
<li><a href="http://web.archive.org/web/20220927121741/https://developers.google.com/android/reference/com/google/android/gms/instantapps/InstantApps.html#showInstallPrompt(android.app.Activity,%20android.content.Intent,%20int,%20java.lang.String)"><span>I</span><span>nstantapps . showinstallprompt</span></a><span>-在您的应用中显示完整的应用版本安装对话框，建议至少有一个绑定安装提示的按钮</span></li>
<li><span>从PackageManager中，</span> <span> <a href="http://web.archive.org/web/20220927121741/https://developers.google.com/android/reference/com/google/android/gms/instantapps/PackageManagerCompat.html#isInstantApp()"> isInstantApp() </a>函数</span> <span>告诉你用户使用的是即时应用还是完全安装的应用。在显示安装提示之前调用它</span></li>
<li><strong>总结</strong></li>
<ul>
<li>总的来说，我认为即时应用会给你的用户和团队带来好处。从用户的角度来看，您无需安装即可获得快速的原生体验。用户可以通过朋友发给他们的链接直接进入你的应用。至于你的团队，你拥有模块化项目的所有好处，易于重构或完全改变各自模块中的特性。有了计划良好的结构，项目维护也将变得容易。</li>
<li>也有一些缺点。您需要记住，您的权限可用性是有限的。因此，如果你的功能使用NFC，你可以忘记将它包括在你的即时应用程序中。一些后台进程受到限制。不要忘记大小限制，仅支持重量为2MB的libs，因此如果没有Proguard，您将无法发布即时应用程序。由于构建即时应用程序的方式，Zip Bundle Proguard不像可安装的apk那样工作，你需要付出更多的努力来解决它。总的来说，我强烈推荐尝试即时应用程序。</li>
<li><span>From the PackageManager, the </span><span><a href="http://web.archive.org/web/20220927121741/https://developers.google.com/android/reference/com/google/android/gms/instantapps/PackageManagerCompat.html#isInstantApp()">isInstantApp()</a> function</span><span> tells you if a user uses an application as Instant App or fully installed. Call it before showing the install prompt</span></li>
</ul>
</ul>
<h2><strong>Summary</strong></h2>
<p><span>Overall I think Instant Apps will bring benefits to your users and your team. From a user perspective, you get a fast native experience without the need of installation. Users will be able to jump right into your app from links sent to them by friends. As for your team, you have all the benefits from modularizing your project, easy to refactor or completely change features each in its own module. Project maintenance will also be easy with well-planned structure. </span></p>
<p><span>There are also some disadvantages. You need to remember that you have limited permission usability. So, if your feature uses NFC you can forget about including it to your Instant App. Some of the background processes are limited. Don't forget about size limitations, support libs weight 2MB alone, so without Proguard, you won't be able to ship your Instant App. Thanks to the way of building Instant Apps, Zip Bundle Proguard doesn't work like in an installable apk and you need to make more effort to work it out. Overall I would highly recommend trying out instant apps.</span></p></div></div>    
</body>
</html>