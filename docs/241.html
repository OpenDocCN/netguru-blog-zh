<html>
<head>
<title>How to Detect and Avoid IDORs in Modern Web Applications?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何检测和避免现代Web应用中的IDORs？</h1>
<blockquote>原文：<a href="http://web.archive.org/web/20230307163032/https://www.netguru.com/blog/how-to-detect-and-avoid-idors-in-modern-web-applications#0001-01-01">http://web.archive.org/web/20230307163032/https://www.netguru.com/blog/how-to-detect-and-avoid-idors-in-modern-web-applications#0001-01-01</a></blockquote><div><span><div class="blog-post__lead h2"><p>不安全的直接对象引用(IDOR)是应用程序的业务逻辑中的一个错误。</p></div><p>这类错误在静态代码分析或代码审查中很难发现。它们无法通过任何种类的附加“神奇”安全设备(如下一代防火墙或web应用程序防火墙)来缓解。这是一个<strong>业务逻辑错误</strong>，在设计或实现阶段出现。带有IDOR的webapp使得任何用户都可以访问其他用户的数据。</p>
<h2>我为什么要在乎？</h2>
<p>不安全的直接对象引用总是会导致未经授权的数据访问，这在GDPR时代可能代价非常高。也许最著名的与IDOR相关的数据泄露是第一美国金融公司。他们被纽约州金融服务局指控泄露了35万份包含高度机密的抵押贷款相关数据的文件。</p>
<p>在欧盟，监管机构没有披露数据泄露的细节，但他们将这种安全问题描述为“确保信息安全的技术和组织措施不足”。这就是为什么很难估计有多少数据泄露是由入侵者造成的。<br/>根据我的经验，<strong>在现代web应用程序中，十个已发现的关键漏洞</strong>中有八个是不安全的直接对象引用。</p>
<h2>为什么会这样？</h2>
<p>通常，培训材料(即<a href="http://web.archive.org/web/20221202094314/https://portswigger.net/web-security/access-control/idor" rel="noopener" target="_blank">ports wigger Web Security Academy</a>)显示IDOR是一个经典Web应用程序的示例，其中可以在浏览器的URL栏中轻松修改请求参数。</p>
<p/><figure class="image&#10;    &#10;    image--framed&#10;    " data-image="" data-component="image">
    <img class="image__content" srcset="http://web.archive.org/web/20221202094314im_/https://lh5.googleusercontent.com/s1U4H9cGn-AgF4vrBuzIislk9SPZHgJ6wwjsSFDl9ubmVHkjWLokPmc--N2erWLGckP9Kjuupprx8cSQXTubNTjLlX1--BNUZFTiZc0C5qTZTlApLyisM-IdbS6Wm2FpgqCINsG- 625w, http://web.archive.org/web/20221202094314im_/https://lh5.googleusercontent.com/s1U4H9cGn-AgF4vrBuzIislk9SPZHgJ6wwjsSFDl9ubmVHkjWLokPmc--N2erWLGckP9Kjuupprx8cSQXTubNTjLlX1--BNUZFTiZc0C5qTZTlApLyisM-IdbS6Wm2FpgqCINsG- 1250w" src="../Images/aa44ddb1f64e62fd423663ed3a67e301.png" alt="" loading="lazy" data-image-content="" data-original-src="http://web.archive.org/web/20221202094314im_/https://lh5.googleusercontent.com/s1U4H9cGn-AgF4vrBuzIislk9SPZHgJ6wwjsSFDl9ubmVHkjWLokPmc--N2erWLGckP9Kjuupprx8cSQXTubNTjLlX1--BNUZFTiZc0C5qTZTlApLyisM-IdbS6Wm2FpgqCINsG-"/>
  </figure><p/>
<p>这样的网址引人注目。大多数测试人员会检查如果参数改变会发生什么，并在应用程序实际部署之前尽早发现漏洞。</p>
<p>然而，现代web应用程序通常使用RESTful或GraphQL APIs。在这类app中，测试IDOR漏洞更加困难。</p>
<p>我将使用<a href="http://web.archive.org/web/20221202094314/https://owasp.org/www-project-juice-shop/" rel="noopener" target="_blank">OWASP Juice Shop</a>测试应用程序来更好地演示这个问题。在这个webapp中，浏览器中可见的URL地址不包含参数，如果操作这些参数，可以很容易地允许测试IDOR。</p>
<p/><figure class="image&#10;    &#10;    image--framed&#10;    " data-image="" data-component="image">
    <img class="image__content" srcset="http://web.archive.org/web/20221202094314im_/https://lh5.googleusercontent.com/-42BXtAXk3buq5D7tBPd3E-_StF9QxR2IjakghcwsTMOYKB0gP-7I-j2dleMPtp8TFMNiCL5wHkm3k1lY_EsNvuxVALzqNmG0awAmaqLWgVhb6_LoHxGiXb564cEXYp-9iLX50kS 624w, http://web.archive.org/web/20221202094314im_/https://lh5.googleusercontent.com/-42BXtAXk3buq5D7tBPd3E-_StF9QxR2IjakghcwsTMOYKB0gP-7I-j2dleMPtp8TFMNiCL5wHkm3k1lY_EsNvuxVALzqNmG0awAmaqLWgVhb6_LoHxGiXb564cEXYp-9iLX50kS 1248w" src="../Images/0fdc1c1639a089729b7f366a50ed4e7b.png" alt="" loading="lazy" data-image-content="" data-original-src="http://web.archive.org/web/20221202094314im_/https://lh5.googleusercontent.com/-42BXtAXk3buq5D7tBPd3E-_StF9QxR2IjakghcwsTMOYKB0gP-7I-j2dleMPtp8TFMNiCL5wHkm3k1lY_EsNvuxVALzqNmG0awAmaqLWgVhb6_LoHxGiXb564cEXYp-9iLX50kS"/>
  </figure><p/>
<p>相反，客户端的浏览器端应用程序向API服务器发送请求，乍一看用户是看不到的。</p>
<p>下面你可以在Chromium中找到DevTools控制台网络视图的截图，显示了向购物车添加商品时发出的请求。</p>
<p/><figure class="image&#10;    &#10;    image--framed&#10;    " data-image="" data-component="image">
    <img class="image__content" srcset="http://web.archive.org/web/20221202094314im_/https://lh3.googleusercontent.com/hYZ2IDG8BeZFqHGtob3rAUXMX4r2mhDSJDL8HULoC3gw8H54IecRhoOGiFHwHqwipSGPhk4UZdyZtnuZ-5rXjAGC7EGt6IT7K71KUEx6bnyhFjj8RWCDPouOyb1juDRSItz2qgq8 624w, http://web.archive.org/web/20221202094314im_/https://lh3.googleusercontent.com/hYZ2IDG8BeZFqHGtob3rAUXMX4r2mhDSJDL8HULoC3gw8H54IecRhoOGiFHwHqwipSGPhk4UZdyZtnuZ-5rXjAGC7EGt6IT7K71KUEx6bnyhFjj8RWCDPouOyb1juDRSItz2qgq8 1248w" src="../Images/e7a4b06023c2c4b771fe932457068940.png" alt="" loading="lazy" data-image-content="" data-original-src="http://web.archive.org/web/20221202094314im_/https://lh3.googleusercontent.com/hYZ2IDG8BeZFqHGtob3rAUXMX4r2mhDSJDL8HULoC3gw8H54IecRhoOGiFHwHqwipSGPhk4UZdyZtnuZ-5rXjAGC7EGt6IT7K71KUEx6bnyhFjj8RWCDPouOyb1juDRSItz2qgq8"/>
  </figure><p/>
<p>同样的情况也发生在移动应用程序中。看起来，由于这些请求是不可见的，所以不可能恶意修改它们并暴露漏洞。<br/> <strong>然而这个假设是不正确的。</strong>对HTTP协议有深入了解的攻击者可以利用这些漏洞并危害应用程序。</p>
<h2>检测现代Web应用程序中的IDOR</h2>
<p>为了测试利用JavaScript AJAX方法与API联系的现代web应用程序，请使用一个web代理，在这个代理上可以拦截和修改这些请求。为了展示这一点，我将使用<a href="http://web.archive.org/web/20221202094314/https://portswigger.net/burp/communitydownload" rel="noopener" target="_blank"> BURP套件。</a></p>
<h2>参数枚举</h2>
<p>在大多数情况下，参数枚举允许用户在应用程序中使用相同权限集访问其他用户的资源(水平移动)。</p>
<p>测试场景如下:</p>
<ol>
<li>使用现有帐户在应用程序中进行身份验证。</li>
<li>执行一系列将由代理人记录的动作(打嗝)。</li>
<li>使用可能指向其他人资源的更改参数重新发送记录的请求(使用Burp套件中的Repeater模块)。</li>
</ol>
<p>在这个特殊的例子中，我将尝试显示其他人购物车中的内容。在Burp历史中，您可以看到一个ID为7的购物车的GET请求已经被发送。这是应用程序的业务逻辑提供的ID，存储在用户的浏览器端。</p>
<p/><figure class="image&#10;    &#10;    image--framed&#10;    " data-image="" data-component="image">
    <img class="image__content" srcset="http://web.archive.org/web/20221202094314im_/https://lh4.googleusercontent.com/N8FD5TZEVrp28FFjlm7SmHTjqvnGhEMIVdhYfc4MEEsmkiRojxAeLu-pCF3Hig3THqTCOsg0yaWddC8TRuUFDKU0dVhXpth7vJa8Z7ArBU-XIT_DdjdRB1iRdQaKJBAVIpGNbGll 624w, http://web.archive.org/web/20221202094314im_/https://lh4.googleusercontent.com/N8FD5TZEVrp28FFjlm7SmHTjqvnGhEMIVdhYfc4MEEsmkiRojxAeLu-pCF3Hig3THqTCOsg0yaWddC8TRuUFDKU0dVhXpth7vJa8Z7ArBU-XIT_DdjdRB1iRdQaKJBAVIpGNbGll 1248w" src="../Images/bc213c913d1952b35bbdca185ccebba7.png" alt="" loading="lazy" data-image-content="" data-original-src="http://web.archive.org/web/20221202094314im_/https://lh4.googleusercontent.com/N8FD5TZEVrp28FFjlm7SmHTjqvnGhEMIVdhYfc4MEEsmkiRojxAeLu-pCF3Hig3THqTCOsg0yaWddC8TRuUFDKU0dVhXpth7vJa8Z7ArBU-XIT_DdjdRB1iRdQaKJBAVIpGNbGll"/>
  </figure><p/>
<p>在这个请求的授权头中，您可以看到当前登录用户的JWT令牌。</p>
<p/><figure class="image&#10;    &#10;    image--framed&#10;    " data-image="" data-component="image">
    <img class="image__content" srcset="http://web.archive.org/web/20221202094314im_/https://lh5.googleusercontent.com/ppSncGLNCEK4R1WM-r-LZgqgBKFKZQjZ6hPLxzxz17OljQ-Pd8a0X7Jhg7pRihzlDz2ue4sfG5TozVt1yh0zKTiRB88KwQa4KKbLfC48Ygl6plG0Jb-5b0aWU4uAdXv4cqaTh9cm 624w, http://web.archive.org/web/20221202094314im_/https://lh5.googleusercontent.com/ppSncGLNCEK4R1WM-r-LZgqgBKFKZQjZ6hPLxzxz17OljQ-Pd8a0X7Jhg7pRihzlDz2ue4sfG5TozVt1yh0zKTiRB88KwQa4KKbLfC48Ygl6plG0Jb-5b0aWU4uAdXv4cqaTh9cm 1248w" src="../Images/2b36ae4591a8cd48c35571bc841c3135.png" alt="" loading="lazy" data-image-content="" data-original-src="http://web.archive.org/web/20221202094314im_/https://lh5.googleusercontent.com/ppSncGLNCEK4R1WM-r-LZgqgBKFKZQjZ6hPLxzxz17OljQ-Pd8a0X7Jhg7pRihzlDz2ue4sfG5TozVt1yh0zKTiRB88KwQa4KKbLfC48Ygl6plG0Jb-5b0aWU4uAdXv4cqaTh9cm"/>
  </figure><p/>
<p>API响应是一个JSON文档，表示登录用户的购物车。它显示了用户ID 22和一个空的“Products”对象，对应于站点上的一个空的购物车视图。</p>
<p/><figure class="image&#10;    &#10;    image--framed&#10;    " data-image="" data-component="image">
    <img class="image__content" srcset="http://web.archive.org/web/20221202094314im_/https://lh4.googleusercontent.com/8DgvWh4MfN29Rki0-GBAiLeTEGN9UgkqI192Cv-WaGsEOPulGrzWhQxCvoluBmzNrreSINxQe2Isf7vCefg9g9nlBRx2oo7uwQEt6i_xcol6mDk1UL_ofBk9G5nCmz1GDV4QWUMi 624w, http://web.archive.org/web/20221202094314im_/https://lh4.googleusercontent.com/8DgvWh4MfN29Rki0-GBAiLeTEGN9UgkqI192Cv-WaGsEOPulGrzWhQxCvoluBmzNrreSINxQe2Isf7vCefg9g9nlBRx2oo7uwQEt6i_xcol6mDk1UL_ofBk9G5nCmz1GDV4QWUMi 1248w" src="../Images/29b0222bf29ec87127e62a974d0e27ed.png" alt="" loading="lazy" data-image-content="" data-original-src="http://web.archive.org/web/20221202094314im_/https://lh4.googleusercontent.com/8DgvWh4MfN29Rki0-GBAiLeTEGN9UgkqI192Cv-WaGsEOPulGrzWhQxCvoluBmzNrreSINxQe2Isf7vCefg9g9nlBRx2oo7uwQEt6i_xcol6mDk1UL_ofBk9G5nCmz1GDV4QWUMi"/>
  </figure><p/>
<p>当我替换请求中的购物车ID时会发生什么？</p>
<p>我再次发送这个请求，将购物车ID参数更改为一个较小的数字。</p>
<p/><figure class="image&#10;    &#10;    image--framed&#10;    " data-image="" data-component="image">
    <img class="image__content" srcset="http://web.archive.org/web/20221202094314im_/https://lh5.googleusercontent.com/0g7pqE8JEtAyZA2MS-Wm7_l8fGv_Am78zPBSr9BNq92Nip_ad7RAgA9RmZB1WvvgJEJQhoOdmjZE8IFloFVxWbWnP8pQatWMuawnw5Go4zYa-zyNpzsVZSaCrt3jKUtfpeNmpO3S 624w, http://web.archive.org/web/20221202094314im_/https://lh5.googleusercontent.com/0g7pqE8JEtAyZA2MS-Wm7_l8fGv_Am78zPBSr9BNq92Nip_ad7RAgA9RmZB1WvvgJEJQhoOdmjZE8IFloFVxWbWnP8pQatWMuawnw5Go4zYa-zyNpzsVZSaCrt3jKUtfpeNmpO3S 1248w" src="../Images/041f840f57ebbac93920cdb09d449b7f.png" alt="" loading="lazy" data-image-content="" data-original-src="http://web.archive.org/web/20221202094314im_/https://lh5.googleusercontent.com/0g7pqE8JEtAyZA2MS-Wm7_l8fGv_Am78zPBSr9BNq92Nip_ad7RAgA9RmZB1WvvgJEJQhoOdmjZE8IFloFVxWbWnP8pQatWMuawnw5Go4zYa-zyNpzsVZSaCrt3jKUtfpeNmpO3S"/>
  </figure><p/>
<p>在响应中，我得到了一个JSON文件，其中包含了其他人购物车中的内容。“产品”对象现在包含苹果汁。还要注意不同的购物车用户ID - 21。</p>
<p/><figure class="image&#10;    &#10;    image--framed&#10;    " data-image="" data-component="image">
    <img class="image__content" srcset="http://web.archive.org/web/20221202094314im_/https://lh6.googleusercontent.com/734MyadiHPlhZVnVYV122t4MhMsFDWHiKrvABW2_m-Asdcjoa69i-O3yJ1di1Jy6PmfbRqvpT21wF4boaSjqJChDx7P3o5MP88ngnE6bWn8Ubt8YuwWgxHNJzLloPHlxiOyMeObn 480w, http://web.archive.org/web/20221202094314im_/https://lh6.googleusercontent.com/734MyadiHPlhZVnVYV122t4MhMsFDWHiKrvABW2_m-Asdcjoa69i-O3yJ1di1Jy6PmfbRqvpT21wF4boaSjqJChDx7P3o5MP88ngnE6bWn8Ubt8YuwWgxHNJzLloPHlxiOyMeObn 960w" src="../Images/884e49a0b2e3b5158799e00a260ec843.png" alt="" loading="lazy" data-image-content="" data-original-src="http://web.archive.org/web/20221202094314im_/https://lh6.googleusercontent.com/734MyadiHPlhZVnVYV122t4MhMsFDWHiKrvABW2_m-Asdcjoa69i-O3yJ1di1Jy6PmfbRqvpT21wF4boaSjqJChDx7P3o5MP88ngnE6bWn8Ubt8YuwWgxHNJzLloPHlxiOyMeObn"/>
  </figure><p/>
<p>所以我们检测到了一个IDOR漏洞。您可以使用相同的方法来测试其他端点和其他HTTP方法，包括那些修改数据的方法，例如将产品添加到购物车。</p>
<h2>访问功能</h2>
<p>在有些应用中，由于用户的角色，对某些功能的访问受到限制。</p>
<p>在测试这样的应用程序时，您应该测试一个场景，在这个场景中，具有较低权限的用户试图执行只为具有较高权限的用户设计的操作。</p>
<ol>
<li aria-level="1">在应用程序中使用具有最高权限的帐户进行身份验证。</li>
<li aria-level="1">在应用程序中执行操作-代理将记录对API的请求。</li>
<li aria-level="1">在应用程序中使用较低权限的帐户进行身份验证，以生成授权头的令牌。</li>
<li aria-level="1">使用更改的授权头重放记录的API请求——使用特权较低的用户的令牌。</li>
</ol>
<h2>预防</h2>
<p>不安全的直接对象引用是一个业务逻辑漏洞。只有在设计和实施阶段才能避免这种情况。</p>
<h2>将安全需求添加到用户故事中</h2>
<p>第一个也是最基本的操作是正确定义每个设计功能中的安全要求。我知道，这听起来很可怕，所以我将用一个例子来说明它是什么。</p>
<p>想象一个定义为“<em>的函数，作为用户，我希望能够显示我的购物车</em>。对于这样一个用户故事，程序员自然会实现一个API方法来显示带有给定标识符的购物车。测试人员将测试这个故事，以确认用户收到了预期的购物车内容。</p>
<p>一个添加了的<strong>安全需求的故事可能是这样的:“<em>作为一个用户，我希望能够查看我的购物车，但前提是我有权访问它。</em>“在这种情况下，开发人员在返回结果之前添加用户权限检查是很自然的。测试人员看到故事中的情况后，将检查用户是否可以访问其他人的资源。</strong></p>
<p>一个更好的措辞可以是这样的:“作为一个用户，我希望能够只显示我自己的购物车，而不显示任何其他用户的购物车”。对于这样一个函数，程序员不是为具有给定ID的cart对象创建GET方法，而是为没有ID参数的专用cart对象创建GET方法(或者“<em> mycart </em>”)。确定该方法将返回哪个购物车将需要获得关于当前登录用户的数据(例如，从JWT令牌)，这将显著降低IDOR漏洞的风险。</p>
<h2>创建适当的单元测试</h2>
<p>下一步是创建适当的单元测试来覆盖边缘情况。如上所示，在故事中定义这些具有<strong>定义的安全需求的案例要容易得多。标准的边缘案例集应包括以下场景:</strong></p>
<ul>
<li aria-level="1">用户未通过身份验证，例如授权头缺失或无效。</li>
<li aria-level="1">用户已通过身份验证，但无权访问资源。</li>
</ul>
<h2>执行全面的集成测试</h2>
<p>下一步是考虑边缘情况的全面集成测试。对于API，必须对每个端点的每个方法进行测试，包括它们在上述情况下的行为。API测试需要专用工具，例如<a href="http://web.archive.org/web/20221202094314/https://www.postman.com/" rel="noopener" target="_blank"> Postman </a>、<a href="http://web.archive.org/web/20221202094314/https://www.zaproxy.org/" rel="noopener" target="_blank"> OWASP ZAP </a>、<a href="http://web.archive.org/web/20221202094314/https://portswigger.net/burp" rel="noopener" target="_blank"> Burp Suite </a>。</p>
<h2>执行渗透测试</h2>
<p>web应用程序的渗透测试至关重要，因为它们提供了针对真实风险的保护的最终状态检查。<a href="http://web.archive.org/web/20221202094314/https://www.enforcementtracker.com/ETid-483" rel="noopener" target="_blank">最近根据GDPR </a>开出的罚单表明，监管机构正在调查过程中考虑<strong>关于测试和测量安全控制</strong>的要求。</p>
<h2>摘要</h2>
<p>我听过下面这句话:“不安全的直接宾语是现代的SQL注入”。根据我的经验，当比较我在渗透测试中发现的漏洞数量时，这是绝对正确的。</p>
<p>不过，有一点小小的不同，这使得防范IDOR变得如此困难:没有任何框架、库或web应用程序防火墙能够防范业务逻辑错误。唯一的解决方案是<a href="http://web.archive.org/web/20221202094314/https://en.wikipedia.org/wiki/Secure_by_design" rel="noopener" target="_blank">“设计的安全性”</a>，在软件开发的早期阶段引入。开发人员不仅要编码，还要设计应用程序，牢记互联网上可能出现的所有威胁。</p></span></div>    
</body>
</html>